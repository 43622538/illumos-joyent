#!/sbin/sh
#
# CDDL HEADER START
#
# The contents of this file are subject to the terms of the
# Common Development and Distribution License (the "License").
# You may not use this file except in compliance with the License.
#
# You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE
# or http://www.opensolaris.org/os/licensing.
# See the License for the specific language governing permissions
# and limitations under the License.
#
# When distributing Covered Code, include this CDDL HEADER in each
# file and include the License file at usr/src/OPENSOLARIS.LICENSE.
# If applicable, add the following below this CDDL HEADER, with the
# fields enclosed by brackets "[]" replaced with your own identifying
# information: Portions Copyright [yyyy] [name of copyright owner]
#
# CDDL HEADER END
#
#
# Copyright 2010 Joyent, Inc.  All rights reserved.
# Use is subject to license terms.

. /lib/svc/share/smf_include.sh

ZPOOL=`svcprop -p config/zpool $SMF_FMRI 2>/dev/null`
ZPOOL=${ZPOOL:-zones}

CONFDIR=/$ZPOOL/config
OPTDS=$ZPOOL/opt
MANFDS=$ZPOOL/manifests

#
# The following is a list of SMF svcs which could be run in a zone, but
# which we're not currently installing on our live image.  If we add any
# of these to the image and we want it to also be available in zones,
# then we need to move the entry to the MANFLIST.
#
# application/cups.xml
# application/font/fc-cache.xml
# application/graphical-login/gdm.xml
# application/management/net-snmp.xml
# application/management/seaport.xml
# application/management/snmpdx.xml
# application/opengl/ogl-select.xml
# application/print/service-selector.xml
# application/security/tcsd.xml
# application/x11/x11-server.xml
# application/x11/xfs.xml
# application/x11/xvnc-inetd.xml
# network/ldap/client.xml
# network/rpc/keyserv.xml
# network/socket-filter-kssl.xml
# network/ssl/kssl-proxy.xml
# network/nfs/rquota.xml
# network/smb/server.xml
# network/dns/server.xml
# network/ftp.xml
# network/finger.xml
# network/comsat.xml
# network/rpc/rstat.xml
# network/rpc/rusers.xml
# network/rpc/spray.xml
# network/rpc/wall.xml
# network/talk.xml
# network/ntp.xml
# network/sendmail-client.xml
# network/smtp-sendmail.xml
# network/telnet.xml
# network/wpa.xml
# network/rpc/gss.xml
# network/security/kadmin.xml
# network/security/krb5kdc.xml
# network/security/ktkt_warn.xml
# network/rpc/smserver.xml
# network/nfs/cbd.xml
# network/nfs/mapid.xml
# network/nfs/status.xml
# network/smb/client.xml
# network/ipmievd.xml
# network/nis/client.xml
# network/rpc/rex.xml
# network/http-apache22.xml
# system/consolekit.xml
# system/device/devices-audio.xml
# system/fm/notify-params.xml
# system/install/system-config.xml
# system/pkgserv.xml
# system/sac.xml
#

#
# The following is a list of SMF svcs which are installed on our live image and
# which could be run in a zone, but which we choose not to run in our zones.
# If we ever do want to run any of these, move the entry to the MANFLIST.
#
# network/nfs/client.xml
# network/nfs/nlockmgr.xml
# network/nfs/server.xml
# system/boot-archive-update.xml
# system/boot-archive.xml
# system/boot-config.xml
#

#
# The following is a list of SMF svc manifests under lib/svc/manifest.  These
# are available on our live image and are runnable in a zone.  Since the zones
# are sharing the base file system with the global zone, we set up so that
# these svcs are configured in the zone.
#
MANFLIST="\
	milestone/multi-user-server.xml \
	milestone/multi-user.xml \
	milestone/name-services.xml \
	milestone/network.xml \
	milestone/single-user.xml \
	milestone/sysconfig.xml \
	network/bridge.xml \
	network/dlmgmt.xml \
	network/dns/client.xml \
	network/dns/install.xml \
	network/dns/multicast.xml \
	network/forwarding.xml \
	network/inetd-upgrade.xml \
	network/inetd.xml \
	network/ipfilter.xml \
	network/ipsec/ike.xml \
	network/ipsec/ipsecalgs.xml \
	network/ipsec/manual-key.xml \
	network/ipsec/policy.xml \
	network/login.xml \
	network/network-initial.xml \
	network/network-install.xml \
	network/network-ipmgmt.xml \
	network/network-ipqos.xml \
	network/network-iptun.xml \
	network/network-location.xml \
	network/network-loopback.xml \
	network/network-netcfg.xml \
	network/network-netmask.xml \
	network/network-physical.xml \
	network/network-routing-setup.xml \
	network/network-service.xml \
	network/rexec.xml \
	network/routing/legacy-routing.xml \
	network/routing/ndp.xml \
	network/routing/rdisc.xml \
	network/routing/ripng.xml \
	network/routing/route.xml \
	network/rpc/bind.xml \
	network/shares/group.xml \
	network/shares/reparsed.xml \
	network/shell.xml \
	network/slp.xml \
	network/ssh.xml \
	system/auditd.xml \
	system/consadm.xml \
	system/console-login.xml \
	system/coreadm.xml \
	system/cron.xml \
	system/cryptosvc.xml \
	system/device/allocate.xml \
	system/device/devices-local.xml \
	system/device/mpxio-upgrade.xml \
	system/early-manifest-import.xml \
	system/extended-accounting.xml \
	system/filesystem/autofs.xml \
	system/filesystem/local-fs.xml \
	system/filesystem/minimal-fs.xml \
	system/filesystem/root-fs.xml \
	system/filesystem/usr-fs.xml \
	system/fmd.xml \
	system/hostid.xml \
	system/hotplug.xml \
	system/identity.xml \
	system/idmap.xml \
	system/keymap.xml \
	system/logadm-upgrade.xml \
	system/manifest-import.xml \
	system/name-service-cache.xml \
	system/pfexecd.xml \
	system/rbac.xml \
	system/rcap.xml \
	system/rmtmpfiles.xml \
	system/sar.xml \
	system/svc/global.xml \
	system/svc/restarter.xml \
	system/system-log.xml \
	system/utmp.xml \
	system/vtdaemon.xml"

#
# If we're running off of a live-image, setup the root file system
# to store the zone configuration data on the zpool.  Also set up
# a persistent /opt directory on the zpool.
#
setup_rootfs()
{
	if [ ! -d $CONFDIR ]; then
		echo "Initializing config dir for zones." >/dev/console
		zfs create $ZPOOL/config
		chmod 755 $CONFDIR

		if [ ! -L /etc/zones ]; then
			cp -p /etc/zones/index $CONFDIR
			cp -p /etc/zones/SUNWdefault.xml $CONFDIR
		else
			echo "global:installed:/" >$CONFDIR/index
			chmod 644 $CONFDIR/index
		fi
	fi

	if [ ! -L /etc/zones ]; then
		cd /
		rm -rf /etc/zones
		ln -s $CONFDIR /etc/zones
	fi

	if [ ! -d /$OPTDS ]; then
		echo "Initializing opt dir." >/dev/console
		zfs create $OPTDS
		chmod 755 /$OPTDS
	fi
	[ ! -d /opt ] && ln -s /$OPTDS /opt

	#
	# Regenerate a manifest dir each time the image boots, so that its
	# always in sync with the running image (and any fixes included there).
	#
	echo "Initializing manifest dir."
	zfs list -H -o name $MANFDS >/dev/null 2>&1 
	[ $? -eq 0 ] && zfs destroy $MANFDS
	zfs create $MANFDS
	cd /lib/svc/manifest
	for i in $MANFLIST
        do
		echo $i
        done | cpio -pdm /$MANFDS
}

# Make sure working directory is / to prevent unmounting problems.
cd /
PATH=/usr/sbin:/usr/bin; export PATH

case "$1" in
'start')
	zpool list -H $ZPOOL >/dev/null 2>&1
	if [ $? -ne 0 ]; then
		# Pool is not imported yet, import now.
		# hostid changes on each net boot, so we have to force import.
		zpool import -f $ZPOOL 2>&1
		if [ $? -ne 0 ]; then
			# Exit OK since this may be the first time the system
			# is booting and the zpool may not be set up yet.
			echo "The zpool \"$ZPOOL\" does not exist." \
			   >/dev/console
			exit $SMF_EXIT_OK
		fi
	fi

	# If running on a live image, make sure root fs is setup.
	mount -p | nawk '{if ($3 == "/") exit (index($1, "ramdisk"))}'
	[ $? -ne 0 ] && setup_rootfs

	# See the comment in the svc manifest on why we invoke the system/zones
	# svc start method directly.
	/lib/svc/method/svc-zones start
	;;

'stop')
	# We don't export the zpool since there is no shutdown dependency and
	# the zones might not have finished shutting down yet.
	;;

*)
	echo "Usage: $0 { start | stop }"
	exit $SMF_EXIT_ERR_FATAL
	;;
esac
exit $SMF_EXIT_OK
